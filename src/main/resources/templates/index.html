<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Interactive de France</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .container-fluid {
            height: 100vh;
            padding: 0;
        }
        
        .map-container {
            height: 100vh;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .sidebar {
            height: 100vh;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-left: 1px solid #dee2e6;
            padding: 1rem;
        }
        
        .city-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        
        .city-item {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .city-item:hover {
            background-color: #e9ecef;
        }
        
        .city-item.highlighted {
            background-color: #ffc107;
            font-weight: bold;
        }
        
        .filters-panel {
            background-color: white;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .city-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            max-width: 250px;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin: 1rem 0;
        }
        
        .stats-info {
            background-color: #e9ecef;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row h-100">
            <!-- Carte -->
            <div class="col-lg-8 p-0">
                <div class="map-container">
                    <div id="map"></div>
                    <div id="cityInfo" class="city-info">
                        <h6 id="cityInfoTitle"></h6>
                        <div id="cityInfoContent"></div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4 sidebar">
                <h4 class="mb-3">üó∫Ô∏è Carte Interactive de France</h4>
                
                <!-- Statistiques -->
                <div class="stats-info">
                    <strong>Base de donn√©es:</strong> <span th:text="${totalCities}">0</span> villes fran√ßaises<br>
                    <small>Cliquez sur la carte pour rechercher des villes proches</small>
                </div>
                
                <!-- Filtres -->
                <div class="filters-panel">
                    <h5>üîç Filtres de recherche</h5>
                    <form id="filtersForm">
                        <div class="row mb-2">
                            <div class="col-6">
                                <label for="maxCities" class="form-label">Nb max villes:</label>
                                <input type="number" class="form-control form-control-sm" id="maxCities" 
                                       value="10" min="1" max="50">
                            </div>
                            <div class="col-6">
                                <label for="maxDistance" class="form-label">Distance max (km):</label>
                                <input type="number" class="form-control form-control-sm" id="maxDistance" 
                                       value="50" min="1" max="500">
                            </div>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-6">
                                <label for="minPopulation" class="form-label">Population min:</label>
                                <input type="number" class="form-control form-control-sm" id="minPopulation" 
                                       value="0" min="0">
                            </div>
                            <div class="col-6">
                                <label for="regionFilter" class="form-label">R√©gion:</label>
                                <select class="form-select form-select-sm" id="regionFilter">
                                    <option value="TOUTES">Toutes les r√©gions</option>
                                    <option th:each="region : ${regions}" th:value="${region}" th:text="${region}"></option>
                                </select>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary btn-sm w-100" id="applyFilters" disabled>
                            Appliquer les filtres
                        </button>
                    </form>
                </div>
                
                <!-- R√©sultats -->
                <div id="resultsSection" style="display: none;">
                    <h5>üìç Villes trouv√©es <span id="cityCount" class="badge bg-primary">0</span></h5>
                    <div id="cityList" class="city-list mb-3">
                        <div class="loading">Aucune recherche effectu√©e</div>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div id="instructions" class="alert alert-info">
                    <h6>üìã Instructions:</h6>
                    <ol class="mb-0">
                        <li>Ajustez les filtres selon vos pr√©f√©rences</li>
                        <li>Cliquez sur la carte pour rechercher des villes</li>
                        <li>Survolez les r√©sultats pour les voir sur la carte</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        let map;
        let currentMarkers = [];
        let currentCities = [];
        let currentSearchMarker = null;
        
        // Limites de la France m√©tropolitaine (coordonn√©es g√©ographiques)
        const FRANCE_BOUNDS = [
            [41.0, -5.5],  // Sud-Ouest
            [51.5, 9.5]    // Nord-Est
        ];
        
        // Coordonn√©es de l'image de carte (√† ajuster selon votre image)
        const IMAGE_BOUNDS = [
            [41.0, -5.5],  // Coin sud-ouest de l'image
            [51.5, 9.5]    // Coin nord-est de l'image
        ];
        
        // Initialisation de la carte
        function initMap() {
            // Cr√©er la carte centr√©e sur la France
            map = L.map('map', {
                center: [46.603354, 1.888334], // Centre de la France
                zoom: 6,
                maxBounds: FRANCE_BOUNDS,
                maxBoundsViscosity: 1.0, // Emp√™che de sortir des limites
                zoomControl: true,
                attributionControl: false
            });
            
            // Ajouter l'image de carte comme couche
            L.imageOverlay('/carte_fr.png', IMAGE_BOUNDS, {
                opacity: 0.8
            }).addTo(map);
            
            // Ajuster la vue pour correspondre aux limites de l'image
            map.fitBounds(IMAGE_BOUNDS);
            
            // Ajouter un contr√¥le d'attribution personnalis√©
            L.control.attribution({
                position: 'bottomright',
                prefix: 'Donn√©es: <a href="/about">Villes fran√ßaises</a>'
            }).addTo(map);
            
            // G√©rer les clics sur la carte
            map.on('click', handleMapClick);
        }
        
        // Gestion des clics sur la carte
        function handleMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // V√©rifier que le clic est en France
            if (!isInFrance(lat, lng)) {
                alert('Veuillez cliquer sur la France m√©tropolitaine');
                return;
            }
            
            console.log('Clic sur la carte:', lat, lng);
            
            // Ajouter un marqueur de recherche
            if (currentSearchMarker) {
                map.removeLayer(currentSearchMarker);
            }
            currentSearchMarker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map);
            
            // Effectuer la recherche
            searchCities(lat, lng);
        }
        
        // V√©rifier si un point est en France
        function isInFrance(lat, lng) {
            return lat >= 41.0 && lat <= 51.5 && lng >= -5.5 && lng <= 9.5;
        }
        
        // Recherche des villes
        async function searchCities(lat, lng) {
            const criteria = {
                latitude: lat,
                longitude: lng,
                maxCities: parseInt(document.getElementById('maxCities').value),
                maxDistance: parseFloat(document.getElementById('maxDistance').value),
                minPopulation: parseInt(document.getElementById('minPopulation').value),
                region: document.getElementById('regionFilter').value
            };
            
            console.log('Crit√®res de recherche:', criteria);
            
            // Afficher le loading
            document.getElementById('cityList').innerHTML = '<div class="loading">Recherche en cours...</div>';
            document.getElementById('resultsSection').style.display = 'block';
            
            try {
                const response = await fetch('/api/cities/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(criteria)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentCities = data.cities;
                    displayCities(data.cities);
                    displayCitiesOnMap(data.cities);
                    document.getElementById('cityCount').textContent = data.count;
                } else {
                    throw new Error(data.error || 'Erreur de recherche');
                }
            } catch (error) {
                console.error('Erreur lors de la recherche:', error);
                document.getElementById('cityList').innerHTML = 
                    '<div class="error">Erreur: ' + error.message + '</div>';
            }
        }
        
        // Affichage des villes dans la liste
        function displayCities(cities) {
            const cityList = document.getElementById('cityList');
            
            if (cities.length === 0) {
                cityList.innerHTML = '<div class="text-muted text-center p-3">Aucune ville trouv√©e</div>';
                return;
            }
            
            const html = cities.map((city, index) => `
                <div class="city-item" data-city-index="${index}" 
                     onmouseenter="highlightCity(${index}, true)" 
                     onmouseleave="highlightCity(${index}, false)">
                    <strong>[${Math.round(city.distance)} km] ${city.name}</strong><br>
                    <small class="text-muted">${city.region}</small><br>
                    <small class="text-muted">Population: ${city.population ? city.population.toLocaleString() : 'N/A'}</small>
                </div>
            `).join('');
            
            cityList.innerHTML = html;
        }
        
        // Affichage des villes sur la carte
        function displayCitiesOnMap(cities) {
            // Supprimer les anciens marqueurs
            currentMarkers.forEach(marker => map.removeLayer(marker));
            currentMarkers = [];
            
            cities.forEach((city, index) => {
                const marker = L.marker([city.latitude, city.longitude])
                    .addTo(map)
                    .bindPopup(`
                        <strong>${city.name}</strong><br>
                        Distance: ${Math.round(city.distance)} km<br>
                        Population: ${city.population ? city.population.toLocaleString() : 'N/A'}<br>
                        R√©gion: ${city.region}
                    `);
                
                marker.cityIndex = index;
                marker.on('mouseover', () => highlightCity(index, true));
                marker.on('mouseout', () => highlightCity(index, false));
                
                currentMarkers.push(marker);
            });
        }
        
        // Mise en surbrillance d'une ville
        function highlightCity(index, highlight) {
            const cityItems = document.querySelectorAll('.city-item');
            if (cityItems[index]) {
                if (highlight) {
                    cityItems[index].classList.add('highlighted');
                } else {
                    cityItems[index].classList.remove('highlighted');
                }
            }
            
            // Affichage des informations
            if (highlight && currentCities[index]) {
                showCityInfo(currentCities[index]);
            } else {
                hideCityInfo();
            }
        }
        
        // Affichage des informations de ville
        function showCityInfo(city) {
            const cityInfo = document.getElementById('cityInfo');
            document.getElementById('cityInfoTitle').textContent = city.name;
            document.getElementById('cityInfoContent').innerHTML = `
                <strong>Population:</strong> ${city.population ? city.population.toLocaleString() : 'N/A'}<br>
                <strong>R√©gion:</strong> ${city.region}<br>
                
                <strong>Distance:</strong> ${Math.round(city.distance)} km
            `;
            cityInfo.style.display = 'block';
        }
        
        // Masquer les informations de ville
        function hideCityInfo() {
            document.getElementById('cityInfo').style.display = 'none';
        }
        
        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // Activer le bouton de recherche apr√®s le premier clic
            map.on('click', function() {
                document.getElementById('applyFilters').disabled = false;
            });
            
            // G√©rer l'application des filtres
            document.getElementById('applyFilters').addEventListener('click', function() {
                if (currentSearchMarker) {
                    const lat = currentSearchMarker.getLatLng().lat;
                    const lng = currentSearchMarker.getLatLng().lng;
                    searchCities(lat, lng);
                }
            });
        });
    </script>
</body>
</html>
